on:
  push:
  issues:
    types: [opened, deleted, closed, reopened, labeled, unlabeled, milestoned, demilestoned]
  issue_comment:
    types: [created, edited, deleted]
  milestone:
    types: [created, edited, deleted]
name: Process changes and deploy

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - name: Cancel previous builds
      uses: styfle/cancel-workflow-action@0.6.0
      with:
        access_token: ${{ secrets.GITHUB_TOKEN }}

    - uses: actions/checkout@master
      with:
        persist-credentials: false
        fetch-depth: 0 

    - name: Process scope issue comments
      uses: ./.github/actions/process-scopes-comments
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        repo_owner: asyncapi
        repo_name: shape-up-process
    
    - name: Update progress.json
      if: github.event_name == 'issue_comment'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "Update progress.json" -a || true
    
    - name: Commit to regenerate data.json
      if: github.event_name == 'issues' || github.event_name == 'milestone'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "Trigger deploy" --allow-empty

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: master